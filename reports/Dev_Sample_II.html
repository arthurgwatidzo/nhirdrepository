<style type="text/css">

	td
	  {
		  padding:0px;
		  font-size:10.0pt;
		  font-weight:400;
		  font-style:normal;
		  text-decoration:none;
		  font-family:Arial;
		  text-align:general;
		  vertical-align:middle;
		  border:none;
	}
	.colheader
	{
		font-weight:700;
		color:#101010;
		border:1px solid #CFCFCF;
		padding:4px;
	}
	.data
	{
		font-weight:400;
		color:#101010;
		border:1px solid #CFCFCF;
		padding:4px;
	}
	.center
	{
		text-align:center;
	}
	.datablockTitle
	{
		font-size:16pt;
		font-weight:700;
		color:#121212;
		padding:4px;
	}
	.datablockDescription
	{
		font-size:9pt;
		font-weight:400;
		color:#121212;
		padding:8px;
	}
	.ReferenceCaption
	{
		font-weight:700;
		color:#101010;
		font-size:10pt;
		text-align:left;
		padding:10px;
	}
	.rounded
	{
		border-top-left-radius: 4px 4px;
		border-bottom-left-radius: 4px 4px;
		border-top-right-radius: 4px 4px;
		border-bottom-right-radius: 4px 4px;
	}
	#figure1 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	/*
	  Minimum height and width is a good idea to prevent negative SVG dimensions...
	  For example width should be =< margin.left + margin.right + 1,
	  of course 1 pixel for the entire chart would not be very useful, BUT should not have errors
	*/
	}
	#figure2 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	}
	#figure3 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	}
	#figure4 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	}
	#figure5 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	}
	#figure6 svg {
		height: 500px;
		width: 1000px;
		margin: 10px;
		min-width: 100px;
		min-height: 100px;
	}
</style>


<script type="text/javascript">

var orgUnit = dhis2.report.organisationUnit;
var orgUnitHierarchy = dhis2.report.organisationUnitHierarchy;
var orgUnitChildren = dhis2.report.organisationUnitChildren;
var period = dhis2.report.periods;

var varJSON;
var outVals = '';
var outCumul = '';
var outCumulOrg = '';
var CumulOrgCount = 0;
var outJSON;

var tbl1Col3 = 0;
var tbl1Col4 = 0;

$(document).ready(

	function() {

	var sJdata = '../api/analytics.json?dimension=pe:' + getParameterByName('pe') + '&dimension=dx:A9s6E9l4W8z;Bt5H0q5L3h7;eo2N8j1S9k4;Dv1K3w4Z3u0;cl2E3i6X5z9&dimension=ou:LEVEL-' + (orgUnitHierarchy.length + 1) + ';' + orgUnit.id + '&hierarchyMeta=true&displayProperty=NAME&showHierarchy=true';
	$.ajax({
		url: sJdata,
		success: function (data) {
			LoadHTMLresultsTable(data,'#DataBlock1Content');
		}
	});

}); //document ready function

function LoadHTMLresultsTable(myData,sDestination){

	var i;
	var p;
	var x;
	var sReturn = '';
	var sBGcol;
	var sCol;
	var iNum = 0;
	var iDen = 0;
	var sLastOU;
	var sParentPath;
	var ParentArr;
	var OUlevelJ;

	var objNames = JSON.parse(JSON.stringify(myData.metaData.names));
	var objParents = JSON.parse(JSON.stringify(myData.metaData.ouNameHierarchy));
	var OUlevelLookup = '../api/organisationUnitLevels.json?fields=id,name,level&paging=false';

	OUlevelJ = $.ajax({url:OUlevelLookup, async: false}).responseText; 

	var objLevels = JSON.parse(OUlevelJ);

	sReturn += '<table class="listTable gridTable"><thead><tr>';

	for(i = 0; i < myData.headers.length; i++) {
		if (myData.headers[i].name == 'ou')
		{
			sParentPath = ReturnLookup(objParents,ReturnLookup(objNames,myData.rows[1][i]));
			ParentArr = sParentPath.split("/");

			for (x=1; x<ParentArr.length; x++)
			{
				sReturn += '<th>';
				sReturn += GetOUlevelName(objLevels,x);
				sReturn += '</th>';
			}

		}
		else{
			if (i < 3)
			{
				sReturn += '<th>' + ReturnLookup(objNames,myData.headers[i].name)  + '</th>';
			}
			else
			{
				sReturn += '<th>' + myData.headers[i].name  + '</th>';
			}
		}
	}

	sReturn += '</tr></tr></thead>';
	sReturn += '<tbody>';

	for(i = 0; i < myData.rows.length; i++) {
		sReturn += '<tr>';
		for(p = 0; p < myData.headers.length; p++) {
			if (myData.headers[p].name == 'ou')
			{
				sParentPath = ReturnLookup(objParents,ReturnLookup(objNames,myData.rows[i][p]));
				ParentArr = sParentPath.split("/");
				
				for (x=1; x<ParentArr.length; x++)
				{
					sReturn += '<td>';
					sReturn += ParentArr[x];
					sReturn += '</td>';
				}

			}
			else{
				if (p < 3)
				{
					sReturn += '<td>' + ReturnLookup(objNames,myData.rows[i][p]) + '</td>';
				}
				else
				{
					sReturn += '<td>' + myData.rows[i][p] + '</td>';
				}
			}
		}
		sReturn += '</tr>';
	}

	sReturn += '</tbody></table>';
	$(sDestination).html(sReturn);
}

function ReturnLookupValue(theData,pe,ou){

	var i;
	var sReturn = '';

	for(i = 0; i < theData.rows.length; i++) {
	
		if (theData.rows[i][2] == pe)
		{
			if (theData.rows[i][1] == ou)
			{
				sReturn = theData.rows[i][3];
			}
		}

	}

	return sReturn;
}

function ReturnLookup(theData,Val){

	sReturn = theData[Val];
	return  sReturn;
}

function ReturnUIDLookupName(theData,Val){

	var i;
	var sReturn = '';

	for(i = 0; i < theData.length; i++) {

		if (theData[i][0] == Val)
		{
			sReturn = theData[i][1];
		}

	}

	if (sReturn == '')
	{
		sReturn = (Val + ': ' + theData.length);
	}
	
	return sReturn;
}

function getParameterByName(name) {0
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function GetOUlevelName(OUlevelJ,iOU){

	var i;
	var sReturn = '';

	for(i = 0; i < OUlevelJ.organisationUnitLevels.length; i++) {

		if (OUlevelJ.organisationUnitLevels[i].level == iOU){

			sReturn = OUlevelJ.organisationUnitLevels[i].name;
		}
		
	}

	return sReturn;
}

function ReturnCumulativeTotal(myData,iCol){

	var i;
	var iLastTot;

	iLastTot = 0;

	for(i = 0; i < myData.rows.length; i++) {
		if (myData.rows[i][iCol] != ''){
			iLastTot += Number(myData.rows[i][iCol]);
		}
	}

	return iLastTot;

}


 function LoadMaxEventDate(myData,iCol){

	var newDate = "";
	var i;
	var iLastTot;
	var MaxDate = '1994-01-01';
	var today = new Date();

	iLastTot = 0;

	for(i = 0; i < myData.rows.length; i++) {
		
		if (myData.rows[i][iCol] != ''){

		if (formatDate(myData.rows[i][iCol]) > formatDate(MaxDate)){
			if (formatDate(myData.rows[i][iCol]) < formatDate(today)){
				MaxDate = formatDate(myData.rows[i][iCol]);
			}
		}
		
		}

	}
	
	console.log(MaxDate);

	//$( "#MAX_TRACKER_ENTRY1" ).html(new Date(MaxDate));

}
function formatDate(dtm)
{
	var dd;
	dd = dtm.getDate();

	var mm;
	mm	= dtm.getMonth()+1; //January is 0!

	var yyyy;
	yyyy = dtm.getFullYear();

	if(dd<10) {
		dd='0'+dd
	} 
	if(mm<10) {
		mm='0'+mm
	} 

    return (yyyy+'-'+mm+'-'+dd);
}


function formatNumber(num)
{
    return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function($1) { return $1 + "," });
}

</script>

<!-- 
<div style='position:absolute;left:600px;top:65px;border:1px solid #0061E9;background-Color:#EBF3FF;width:225px;padding:4px;text-align:center;' class='rounded'>
	<a href='../api/sqlViews/blVRaoJDeI2/data.csv'>Download Registration Pivot Data</a><br>
</div>
-->

<table style='width:900px;height:100%;'>

 <tr>
  <td style='width:28px;' rowspan=500>&nbsp;</td>
  <td id='logoArea' name='logoArea' style='text-align:left;'>
	Two API calls make it possible to build up the orgunit-hierarchy with OUlevel captions
  </td>
  <td style='width:28px;' rowspan=500>&nbsp;</td>
 </tr>


 <!-- # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # -->
 
 <tr>
  <td style='color:#CFCFCF;font-size:8pt;height:10px;' colspan=3>
	&nbsp;
  </td>
 </tr>


 <tr>
  <td id='DataBlock1Content' name='DataBlock1Content' style='' colspan=3>
 
 
  </td>
 </tr>

 <!-- # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # -->
 

 <tr>
  <td style='height:50%;' colspan=3>&nbsp;</td>
 </tr>

</table>
