
    <link class="include" rel="stylesheet" type="text/css" href="http://timesheets.hisp.org/timesheets/population/css/jquery.jqplot.min.css" />
    <link rel="stylesheet" type="text/css" href="http://timesheets.hisp.org/timesheets/population/css/examples.min.css" />
    <link type="text/css" rel="stylesheet" href="http://timesheets.hisp.org/timesheets/population/css/shCoreDefault.min.css" />
    <link type="text/css" rel="stylesheet" href="http://timesheets.hisp.org/timesheets/population/css/shThemejqPlot.min.css" />
  
	<!--[if lt IE 9]><script language="javascript" type="text/javascript" src="../excanvas.js"></script><![endif]-->
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jquery.min.js"></script>
    
    <link class="include" type="text/css" href="http://timesheets.hisp.org/timesheets/population/css/jquery-ui.min.css" rel="Stylesheet" /> 
    <link href="http://timesheets.hisp.org/timesheets/population/css/jquery.colorpicker.css" rel="stylesheet" type="text/css"/>

    <style type="text/css">

        html {
            width: 100%;
            height: 100%;
        }

        body {
            width: 98%;
            height: 97%;
            margin: 6px;
        }

        .quintile-outer-container {
            width: 97%;
            height: 97%;
            margin: auto;
        }

        .jqplot-chart {
            width: 800px;
            height: 700px;
        }

        .quintile-toolbar .ui-icon {
            float: right;
            margin: 3px 5px;
        }

        table.stats-table td, table.highlighted-stats-table td {
            background-color: rgb(230, 230, 230);
            padding: 0.5em;
        }

        col.label {
            width: 14em;
        }

        col.value {
            width: 7em;
        }

        td.quintile-value {
            width: 7em;
            text-align: right;
        }

        table.stats-table td.tooltip-header, table.highlighted-stats-table td.tooltip-header {
            background-color: rgb(200, 200, 200);
        }

        table.stats-table, table.highlighted-stats-table, td.contour-cell {
            font-size: 0.7em;
        }

        td.contour-cell {
            height: 1.5em;
            padding-left: 20px;
            padding-bottom: 1.5em;
        }

        table.highlighted-stats-table {
            margin-top: 15px;
        }

        div.stats-cell div.input {
            font-size: 0.7em;
            margin-top: 1.5em;
        }

        div.content-container {
            padding-left: 230px;   /* LC width */
            padding-right: 300px;  /* RC width */
            height: 100%;
        }

        div.content-container .column {
            position: relative;
            float: left;
        }

        div.controls {
            width: 170px;          /* LC width */
            right: 230px;          /* LC width */
            padding-left: 30px;
            padding-right: 30px;
            margin-left: -100%;
            margin-top: 30px;
        }

        div.chart-cell {
            width: 100%;
            height: 100%;
        }

        div.stats-cell {
            width: 270px;          /* RC width */
            margin-right: -300px;  /* RC width */
            padding-right: 30px;
            margin-top: 30px;
        }

        div.controls, div.controls select {
            font-size: 0.8em;
        }

        div.controls li {
            list-style-type: none;
        }

        div.controls ul {
            margin-top: 0.5em;
            padding-left: 0.2em;
        }

        div.overlay-chart-container {
            display: none;
            z-index: 11;
            position: fixed;
            width: 800px;
            left: 50%;
            margin-left: -400px;
            background-color: white;
        }

        div.overlay-chart-container div.ui-icon {
            float: right;
            margin: 3px 5px;
        }

        div.overlay-shadow {
            display: none;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
        }

        div.ui-colorpicker div.ui-dialog-titlebar {
            padding: 0.1em 0.3em;
        }

        input.color {
            display: none;
        }

        div.colorpicker-container span {
            padding: 3px;
        }

        div.quintile-content {
            width: 100%;
            height: 100%;
        }


        @media print {
            div.stats-cell {
                vertical-align: top;
                padding-top: 35px;
            }

            table.stats-table, table.stats-table td {
                 color: #aaaaaa;
                 border: 1px solid #bbbbbb;
                 border-collapse: collapse;
            }

            table.stats-table tr {
                font-family: Verdana,Arial,sans-serif;
                /*font-size: 0.7em;*/
            }
        }

    </style>


<!-- Example scripts go here -->

    <div class="overlay-shadow"></div>

    <div class="overlay-chart-container ui-corner-all">
        <div class="overlay-chart-container-header ui-widget-header ui-corner-top">Right click the image to Copy or Save As...<div class="ui-icon ui-icon-closethick"></div></div>
        <div class="overlay-chart-container-content ui-corner-bottom"></div>
    </div>

    <div class="quintile-outer-container ui-widget ui-corner-all">
        <div class="quintile-toolbar ui-widget-header  ui-corner-top">
            <span class="quintile-title" id="ChartTitle" name="ChartTitle">&nbsp;</span>
        </div>
        <div class="quintile-content ui-widget-content ui-corner-bottom">

            <div class="content-container">


            <div class="chart-cell column">
                <div id="agesChart" class="jqplot-chart"></div>
            </div>


            <div class="controls column">
                <table>
                    <tr>
                        <td>
                            Axes:
                        </td>
                        <td>
                            <select name="axisPosition">
                                <option value="both">Left &amp; Right</option>
                                <option value = "left">Left</option>
                                <option value = "right">Right</option>
                                <option value = "mid">Mid</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Colors:
                        </td>
                        <td>
                            <ul>
                                <li><input class="color" type="color" id="colorLeft" value="#0000ff" /> Left</li>
                                <li><input class="color" type="color" id="colorRight" value="#ff00c3" /> Right</li>
                                <li><input class="color" type="color" id="colorBackground"  value="#FFFFFF" /> Background</li>
                                <li><input class="color" type="color" id="colorPlotBands" value="#F5F5F5" /> Plot Bands</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Grids:
                        </td>
                        <td>
                            <ul>
                                <li><input name="gridsVertical" value="vertical" type="checkbox" />Vertical</li>
                                <li><input name="gridsHorizontal" value="horizontal" type="checkbox" />Horizontal</li>
                                <li><input name="showMinorTicks" value="true" type="checkbox" checked />Only major</li>
                                <li><input name="plotBands" value="true" type="checkbox" checked />Plot Bands</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <ul>
                                <li><input name="barPadding" value="2" type="checkbox" checked />Gap between bars</li>
                                <!-- value for showContour is speed at which to fade lines in/out -->
                                <li><input name="showContour" value="500" type="checkbox" />Comparison Line</li>
                            </ul>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="stats-cell column">
                <table class="stats-table">
                <colgroup>
                    <col class="label">
                    <col class="value">
                </colgroup>
                <tbody>
                    <tr>
                        <td style='text-align:right;'>Total Population:</td>
                        <td class="quintile-value summary-populationTotal"></td>
                    </tr>
                    <tr>
                        <td id='LeftTotalPopGroupName' style='text-align:right;'>Total Left:</td>
                        <td class="quintile-value summary-populationMale"></td>
                    </tr>
                    <tr>
                        <td id='RightTotalPopGroupName' class="ui-corner-bl" style='text-align:right;'>Total Right:</td>
                        <td class="quintile-value summary-populationFemale ui-corner-br"></td>
                    </tr>
                    <tr>
                        <td class="ui-corner-tl" title="Age at which half the population are below and half the population are above" style='text-align:right;'>Median Age:</td>
                        <td class="quintile-value summary-medianTotal ui-corner-tr"></td>
                    </tr>
                    <tr>
                        <td id='LeftMedianGroupName' style='text-align:right;'>Median Left:</td>
                        <td class="quintile-value summary-medianLeft"></td>
                    </tr>
                    <tr>
                        <td id='RightMedianGroupName' style='text-align:right;'>Median Right:</td>
                        <td class="quintile-value summary-medianRight"></td>
                    </tr>
                </tbody>
                </table>
                <table class="highlighted-stats-table">
                <colgroup>
                    <col class="label">
                    <col class="value">
                </colgroup>
                <tbody>
                    <tr class="tooltip-header">
                        <td class="tooltip-header ui-corner-top" colspan="2">Highlighted Age: <span class="tooltip-item tooltipAge">&nbsp;</span></td>
                    </tr>
                    <tr>
                        <td>Male: </td>
                        <td class="quintile-value"><span class="tooltip-item tooltipMale">&nbsp;</span></td>
                    </tr>
                    <tr>
                        <td>Female: </td>
                        <td class="quintile-value"><span class="tooltip-item tooltipFemale">&nbsp;</span></td>
                    </tr>
                    <tr>
                        <td class="ui-corner-bl">Ratio: </td>
                        <td class="quintile-value ui-corner-br"><span class="tooltip-item tooltipRatio">&nbsp;</span></td>
                    </tr>
                <tbody>
                </table>
            </div>

            </div>

        </div>
    </div> 
  


    <script class="code" type="text/javascript">

	var orgUnit = dhis2.report.organisationUnit;
	var orgUnitHierarchy = dhis2.report.organisationUnitHierarchy;
	var orgUnitChildren = dhis2.report.organisationUnitChildren;
	var period = dhis2.report.periods;
	var repuid = getParameterByName('uid');
	var pe = getParameterByName('pe');
	
    $(document).ready(function(){

        // if browser supports canvas, show additional toolbar icons
        if (!$.jqplot.use_excanvas) {
            $('div.quintile-toolbar').append('<div class="ui-icon ui-icon-image"></div><div class="ui-icon ui-icon-print"></div>');
        }
		
		$('#ChartTitle').html('&nbsp;' + orgUnit.name);


        // for this demo, all data is same for each quintile.
        // could do something like this to get the index of the quintile.
        // <!-- var quintileIndex = parseInt(< ? php echo $_GET["qidx"]; ? >); -->

		var Lside = '';
		var Rside = '';
		var Luid = '';
		var Ruid = '';
		var LRuid = '';
		var CohortScale = '';
		var CohortGroups = '';
		var CohortLow;
		var CohortHigh;

		var pyrURL = '../api/sqlViews/DBWajbtnvvE/data.json?criteria=uid:AabCcDdEeF';
		var myPyrJSON = JSON.parse($.ajax({url:pyrURL, async: false}).responseText);
		
		//console.log(pyrURL);

		for(i = 0; i < myPyrJSON.rows.length; i++) {
			if (CohortScale == ''){
				CohortScale = parseFloat(myPyrJSON.rows[i][3]);
				Lside = myPyrJSON.rows[i][4].trim();
				Rside = myPyrJSON.rows[i][5].trim();
			}
			//if (i < myPyrJSON.rows.length)
			{
				CohortLow = parseFloat(CohortScale * i);
				if (i == (myPyrJSON.rows.length-1)){
					Luid += (myPyrJSON.rows[i][7]);
					Ruid += (myPyrJSON.rows[i][8]);
					LRuid += (myPyrJSON.rows[i][7] + ';' + myPyrJSON.rows[i][8]);
					CohortGroups += (CohortLow.toString() + '+,""');
				}
				else{
					Luid += (myPyrJSON.rows[i][7] + ';');
					Ruid += (myPyrJSON.rows[i][8] + ';');
					LRuid += (myPyrJSON.rows[i][7] + ';' + myPyrJSON.rows[i][8] + ';');
					
					if (CohortScale > 1){
						CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale) -1);
						CohortGroups += (CohortLow.toString() + '-' + CohortHigh.toString() + ',');
					}
					else{
						if (CohortScale == 1){
							CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale));
							CohortGroups += (CohortLow.toString() + ',');
						}
						else{
							CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale));
							CohortGroups += (CohortLow.toString() + '-' + CohortHigh.toString() + ',');
						}
					}
				}
			}

		}

		$('#LeftMedianGroupName').html(Lside);
		$('#RightMedianGroupName').html(Rside);

		$('#LeftTotalPopGroupName').html(Lside);
		$('#RightTotalPopGroupName').html(Rside);

		$('#colorLeft').html(Lside);
		$('#colorRight').html(Rside);

		//var sPopURL = '../api/analytics.json?dimension=dx:' + LRuid + '&dimension=pe:' + pe + ';' + (parseFloat(pe)-1) + '&filter=ou:' + orgUnit.id + '&displayProperty=NAME&outputIdScheme=ID'
		var sPopURL = '../api/analytics.json?dimension=dx:' + LRuid + '&dimension=pe:' + pe + '&filter=ou:' + orgUnit.id + '&displayProperty=NAME&outputIdScheme=ID'
		var myPopJSON = JSON.parse($.ajax({url:sPopURL, async: false}).responseText);

		//LoadHTMLresultsTable(myPopJSON,'#DataBlock1Content');

		//console.log(sPopURL);

		var ArrL = Luid.split(";");
		var ArrR = Ruid.split(";");
		var LeftPop = 0;
		var RightPop = 0;
		var TotPop = 0;
		var LRratios = '';
		var LeftVals = '';
		var RightVals = '';
		var LeftTot = 0;
		var RightTot = 0;
		var GrandTot = 0;
		var LastCummul = 0;

		for(i = 0; i < ArrL.length; i++) {

			LeftPop = parseFloat(ReturnLookup(myPopJSON,ArrL[i],pe));
			RightPop = parseFloat(ReturnLookup(myPopJSON,ArrR[i],pe));

			LeftTot += parseFloat(LeftPop);
			RightTot += parseFloat(RightPop);
			TotPop += (parseFloat(LeftPop) + parseFloat(RightPop));

			CohortLow = parseFloat(CohortScale * i);
			CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale) -1);

			//console.log('[' + CohortLow + '-' + CohortHigh + '], ' + Lside + ':' + parseFloat(LeftPop) + ' ' + Rside + ':' + parseFloat(RightPop) + ' [CohortScale: ' + CohortScale + ']');

		}

		var TotMedianPos = parseFloat((parseFloat(TotPop) + 1) / 2)
		var TotMedianVal = 0;
		var TotMedianPosPerc;
		var TotMedianPop;
		var TotMedianAge;
		var TotCumulTest = 0;

		var LeftMedianPos = parseFloat((parseFloat(LeftTot) + 1) / 2)
		var LeftMedianVal = 0;
		var LeftMedianPosPerc;
		var LeftMedianPop;
		var LeftMedianAge;
		var LeftCumulTest = 0;

		var RightMedianPos = parseFloat((parseFloat(RightTot) + 1) / 2)
		var RightMedianVal = 0;
		var RightMedianPosPerc;
		var RightMedianPop;
		var RightMedianAge;
		var RightCumulTest = 0;
		
		var iBandIncr;

		for(i = 0; i < ArrL.length; i++) {

			LeftPop = parseFloat(ReturnLookup(myPopJSON,ArrL[i],pe));
			RightPop = parseFloat(ReturnLookup(myPopJSON,ArrR[i],pe));

			if (i == ( ArrL.length-1)){
				LeftVals += (parseFloat(LeftPop) / parseFloat(TotPop));
				RightVals += (parseFloat(RightPop) / parseFloat(TotPop));
				LRratios += parseFloat(LeftPop) / parseFloat(RightPop);
			}
			else{
				LeftVals += ((parseFloat(LeftPop) / parseFloat(TotPop)) + ',');
				RightVals += ((parseFloat(RightPop) / parseFloat(TotPop)) + ',');
				LRratios += (parseFloat(LeftPop) / parseFloat(RightPop) + ',');
			}

			/* DETERMINE TOT-POP MEDIAN AGE */
			if (TotMedianVal == 0){
				if (TotCumulTest < TotMedianPos){
					LastCummul = TotCumulTest;
					TotCumulTest += (parseFloat(LeftPop) + parseFloat(RightPop));
					if (TotCumulTest >= TotMedianPos){
						TotMedianVal = i;
						TotMedianPop = parseFloat(parseFloat(TotCumulTest) - parseFloat(LastCummul));
						TotMedianPosPerc = parseFloat(parseFloat(parseFloat(TotCumulTest) - parseFloat(LastCummul)) - parseFloat(parseFloat(TotCumulTest) - parseFloat(TotMedianPos))) / parseFloat(parseFloat(TotCumulTest) - parseFloat(LastCummul));
						CohortLow = parseFloat(CohortScale * i);
						CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale) -1);
						iBandIncr = parseFloat(parseFloat(CohortScale) * parseFloat(TotMedianPosPerc));
						TotMedianAge = parseFloat(CohortLow) + parseFloat(iBandIncr);
						//console.log('TotMedianVal: ' + (TotMedianVal +1) + '; group: [' + CohortLow + ' - ' + CohortHigh + '] range ' + TotMedianPop + ' MedianPos: ' + TotMedianPos + ' % in Cohort: ' + TotMedianPosPerc + ' BandIncr: ' + iBandIncr + ' TotMedianAge: ' + TotMedianAge);
					}
				}
			}

			/* DETERMINE LEFT-POP MEDIAN AGE */
			if (LeftMedianVal == 0){
				if (LeftCumulTest < LeftMedianPos){
					LastCummul = LeftCumulTest;
					LeftCumulTest += parseFloat(LeftPop);
					if (LeftCumulTest >= LeftMedianPos){
						LeftMedianVal = i;
						LeftMedianPop = parseFloat(parseFloat(LeftCumulTest) - parseFloat(LastCummul));
						LeftMedianPosPerc = parseFloat(parseFloat(parseFloat(LeftCumulTest) - parseFloat(LastCummul)) - parseFloat(parseFloat(LeftCumulTest) - parseFloat(LeftMedianPos))) / parseFloat(parseFloat(LeftCumulTest) - parseFloat(LastCummul));
						CohortLow = parseFloat(CohortScale * i);
						CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale) -1);
						iBandIncr = parseFloat(parseFloat(CohortScale) * parseFloat(LeftMedianPosPerc));
						LeftMedianAge = parseFloat(CohortLow) + parseFloat(iBandIncr);
						//console.log('LeftMedianVal: ' + (LeftMedianVal +1) + '; group: [' + CohortLow + ' - ' + CohortHigh + '] range ' + LeftMedianPop + ' MedianPos: ' + LeftMedianPos + ' % in Cohort: ' + LeftMedianPosPerc + ' BandIncr: ' + iBandIncr + ' LeftMedianAge: ' + LeftMedianAge);
					}
				}
			}

			/* DETERMINE RIGHT-POP MEDIAN AGE */
			if (RightMedianVal == 0){
				if (RightCumulTest < RightMedianPos){
					LastCummul = RightCumulTest;
					RightCumulTest += parseFloat(RightPop);
					if (RightCumulTest >= RightMedianPos){
						RightMedianVal = i;
						RightMedianPop = parseFloat(parseFloat(RightCumulTest) - parseFloat(LastCummul));
						RightMedianPosPerc = parseFloat(parseFloat(parseFloat(RightCumulTest) - parseFloat(LastCummul)) - parseFloat(parseFloat(RightCumulTest) - parseFloat(RightMedianPos))) / parseFloat(parseFloat(RightCumulTest) - parseFloat(LastCummul));
						CohortLow = parseFloat(CohortScale * i);
						CohortHigh = (parseFloat(CohortLow) + parseFloat(CohortScale) -1);
						iBandIncr = parseFloat(parseFloat(CohortScale) * parseFloat(RightMedianPosPerc));
						RightMedianAge = parseFloat(CohortLow) + parseFloat(iBandIncr);
						//console.log('RightMedianVal: ' + (RightMedianVal +1) + '; group: [' + CohortLow + ' - ' + CohortHigh + '] range ' + RightMedianPop + ' MedianPos: ' + RightMedianPos + ' % in Cohort: ' + RightMedianPosPerc + ' BandIncr: ' + iBandIncr + ' RightMedianAge: ' + RightMedianAge);
					}
				}
			}

		}

		//console.log('LeftVals: ' + LeftVals);
		//console.log('RightVals: ' + RightVals);

		var J1temp = TotPop + ',' + LeftTot + ',' + RightTot + ',' + TotMedianAge + ',' + LeftMedianAge + ',' + RightMedianAge + ',' + 54;

		var J1 = J1temp.split(',');
		var J2 = LeftVals.split(',');
		var J3 = RightVals.split(',');
		var J4 = LRratios.split(',');
		var J5 = CohortGroups.split(',');

        var left;
        var right;
        var summaryTable;
        var sexRatios;
        jsondata = [];
		jsondata.push (J1);
		jsondata.push (J2);
		jsondata.push (J3);
		jsondata.push (J4);
		jsondata.push (J5);
		
		console.log(JSON.stringify(jsondata));
/*
        $.ajax({
            type: "GET",
            dataType: 'json',
            async: false,
            url: "dhis2_ages.json",
            contentType: "application/json",
            success: function (retdata) {
                // array of arrays of data for each quintile
                // each quintile array has data for following:
                //  0: summary table
                //  1: male data
                //  2: female data
                //  3: ratios
                jsondata = retdata;
            },
            error: function (xhr) { console.log("ERROR: ", xhr.statusText) }
        }); */

        // the "x" values from the data will go into the ticks array.  
        // ticks should be strings for this case where we have values like "75+"
        var ticks = jsondata[4];

        $('td.summary-medianTotal').each(function(index) {
            $(this).html($.jqplot.sprintf('%5.2f', jsondata[0][3]));
        });

        $('td.summary-medianLeft').each(function(index) {
            $(this).html($.jqplot.sprintf('%5.2f', jsondata[0][4]));
        });

        $('td.summary-medianRight').each(function(index) {
            $(this).html($.jqplot.sprintf('%5.2f', jsondata[0][5]));
        });

        $('td.summary-populationTotal').each(function(index) {
            $(this).html($.jqplot.sprintf("%'d", jsondata[0][0]));
        });

        $('td.summary-populationMale').each(function(index) {
            $(this).html($.jqplot.sprintf("%'d", jsondata[0][1]));
        });

        $('td.summary-populationFemale').each(function(index) {
            $(this).html($.jqplot.sprintf("%'d", jsondata[0][2]));
        });
        
        // These two variables should be removed outside of the jqplot.com example environment.
        $.jqplot._noToImageButton = true;
        $.jqplot._noCodeBlock = true;

        // Custom color arrays are set up for each series to get the look that is desired.
        // Two color arrays are created for the default and optional color which the user can pick.
        var defaultColors = ["#0000ff", "#ff00c3", "#ffffff", "#dddddd"];
		var greenColors = ["#526D2C", "#77933C", "#C57225", "#C57225"];
        var blueColors = ["#3F7492", "#4F9AB8", "#C57225", "#C57225"];

        // To accomodate changing y axis, need to keep track of plot options.
        // changing axes will require recreating the plot, so need to keep 
        // track of state changes.
        var plotOptions = {
            // We set up a customized title which acts as labels for the left and right sides of the pyramid.
            title: {
                text: '<span style="margin-left:25%;">' + Lside + '</span><span style="margin-left:33%;">' + Rside + '</span>',
                textAlign: 'left'
            },
            // by default, the series will use the green color scheme.
            seriesColors: defaultColors,

            grid: {
                drawBorder: false,
                shadow: false,
                background: "#ffffff",
                rendererOptions: {
                    // plotBands is an option of the pyramidGridRenderer.
                    // it will put banding at starting at a specified value
                    // along the y axis with an adjustable interval.
                    plotBands: {
                        show: true,
                        interval: (10 / CohortScale),
                        color: 'rgb(245, 235, 215)'
                    }
                }
            },

            // This makes the effective starting value of the axes 0 instead of 1.
            // For display, the y axis will use the ticks we supplied.
            defaultAxisStart: 0,
            seriesDefaults: {
                renderer: $.jqplot.PyramidRenderer,
                rendererOptions: {
                    barPadding: 1.5,
                    offsetBars: true
                },
                yaxis: "yaxis",
                shadow: false
            },

            // We have 4 series, the left and right pyramid bars and
            // the left and rigt overlay lines.
            series: [
                // For pyramid plots, the default side is right.
                // We want to override here to put first set of bars
                // on left.
                {
                    rendererOptions:{
                        side: "left",
                        synchronizeHighlight: 1
                    }
                },
                {
                    yaxis: "y2axis",
                    rendererOptions: {
                        synchronizeHighlight: 0
                    }
                },
                {
                    rendererOptions: {
                        fill: false,
                        side: 'left'
                    }
                },
                {
                    yaxis: 'y2axis',
                    rendererOptions: {
                        fill: false
                    }
                }
            ],
            axesDefaults: {
                tickOptions: {
                    showGridline: false
                },
                pad: 0,
                rendererOptions: {
                    baselineWidth: 2
                }
            },

            // Set up all the y axes, since users are allowed to switch between them.
            // The only axis that will show is the one that the series are "attached" to.
            // We need the appropriate options for the others for when the user switches.
            axes: {
                xaxis: {
                    tickOptions: {
                        formatter: $.jqplot.PercentTickFormatter,
                        formatString: '%.1f%%'
                    }
                },
                yaxis: {
                    label: orgUnit.name,
                    // Use canvas label renderer to get rotated labels.
                    labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                    // include empty tick options, they will be used
                    // as users set options with plot controls.
                    tickOptions: {},
                    showMinorTicks: false,
                    tickInterval: 5,
                    ticks: ticks,
                    rendererOptions: {
                        tickSpacingFactor: 15,
                        category: false
                    }
                },
                yMidAxis: {
                    label: "Age",
                    // include empty tick options, they will be used
                    // as users set options with plot controls.
                    tickOptions: {},
                    showMinorTicks: false,
                    tickInterval: 5,
                    ticks: ticks,
                    rendererOptions: {
                        tickSpacingFactor: 15,
                        category: false
                    }
                },
                y2axis: {
                    label: pe + " Age",
                    // Use canvas label renderer to get rotated labels.
                    labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                    // include empty tick options, they will be used
                    // as users set options with plot controls.
                    tickOptions: {},
                    showMinorTicks: false,
                    tickInterval: 5,
                    ticks: ticks,
                    rendererOptions: {
                        tickSpacingFactor: 15,
                        category: false
                    }
                }
            }
        };

        // resize the chart container to fill the space
        $('#agesChart').height($('div.chart-cell').height()*0.96);
        $('#agesChart').width($('div.chart-cell').width()*0.97);

        // $('#agesChart').jqplot([jsondata[1], jsondata[2]], plotOptions);
        $.jqplot.config.addDomReference = true;
        var plot1 = $.jqplot('agesChart', [jsondata[1], jsondata[2]], plotOptions);

        $(window).resize (function(event, ui) {
            // pass in resetAxes: true option to get rid of old ticks and axis properties
            // which should be recomputed based on new plot size.
            $('#agesChart').height($('div.chart-cell').height()*0.96);
            $('#agesChart').width($('div.chart-cell').width()*0.97);
            plot1.replot( { resetAxes: true } );
        });

        // initialize form elements
        // set these before attaching event handlers.
/*
        $("input[type=checkbox][name=gridsVertical]").attr("checked", false);
        $("input[type=checkbox][name=gridsHorizontal]").attr("checked", false);
        $("input[type=checkbox][name=showMinorTicks]").attr("checked", true);
        $("input[type=checkbox][name=plotBands]").attr("checked", true);
        $("input[type=checkbox][name=showContour]").attr("checked", true);
        $("input[type=checkbox][name=barPadding]").attr("checked", true);
        $("select[name=axisPosition]").val("both");
*/
        //////
        // The followng functions use verbose css selectors to make
        // it clear exactly which elements they are binging to/operating on
        //////

        $("select[name=axisPosition]").change(function(){ 
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.

            var opts = {series:[{}, {}, {}, {}]};

            switch ($(this).val()) {
                case "both":
                    opts.series[0].yaxis = "yaxis";
                    opts.series[1].yaxis = "y2axis";
                    opts.series[2].yaxis = "yaxis";
                    opts.series[3].yaxis = "y2axis";
                    break;
                case "left":
                    opts.series[0].yaxis = "yaxis";
                    opts.series[1].yaxis = "yaxis";
                    opts.series[2].yaxis = "yaxis";
                    opts.series[3].yaxis = "yaxis";
                    break;
                case "right":
                    opts.series[0].yaxis = "y2axis";
                    opts.series[1].yaxis = "y2axis";
                    opts.series[2].yaxis = "y2axis";
                    opts.series[3].yaxis = "y2axis";
                    break;
                case "mid":
                    opts.series[0].yaxis = "yMidAxis";
                    opts.series[1].yaxis = "yMidAxis";
                    opts.series[2].yaxis = "yMidAxis";
                    opts.series[3].yaxis = "yMidAxis";
                    break;
                default:
                    break;
                    
            }

            plot1.replot(opts); 
        });

        // bind to the data highlighting event to make custom tooltip:
        $(".jqplot-target").each(function(index){
            $(this).bind("jqplotDataHighlight", function(evt, seriesIndex, pointIndex, data) {
                // Here, assume first series is male poulation and second series is female population.
                // Adjust series indices as appropriate.
                var plot = $(this).data('jqplot');
                var leftPopulation = Math.abs(plot.series[0].data[pointIndex][1]) * jsondata[0][1];
                var rightPopulation = Math.abs(plot.series[1].data[pointIndex][1]) * jsondata[0][2];
                var leftPopulation = jsondata[1][pointIndex] * jsondata[0][1];
                var rightPopulation = jsondata[2][pointIndex] * jsondata[0][2];
                // var ratio = femalePopulation / malePopulation * 100;
                var ratio = jsondata[3][pointIndex];

                $('.tooltipMale').stop(true, true).fadeIn(350).html($.jqplot.sprintf("%'d", leftPopulation));
                $('.tooltipFemale').stop(true, true).fadeIn(350).html($.jqplot.sprintf("%'d", rightPopulation));
                $('.tooltipRatio').stop(true, true).fadeIn(350).html($.jqplot.sprintf('%5.2f', ratio));

                // Since we don't know which axis is rendererd and acive with out a little extra work,
                // just use the supplied ticks array to get the age label.
                $('.tooltipAge').stop(true, true).fadeIn(350).html(ticks[pointIndex]);
            });
        });

        // bind to the data highlighting event to make custom tooltip:
        $(".jqplot-target").each(function() {
            $(this).bind("jqplotDataUnhighlight", function(evt, seriesIndex, pointIndex, data) {
                // clear out all the tooltips.
                $(".tooltip-item").fadeOut(250);
            });
        });

        $('.ui-icon-print').click(function(){
            $(this).parent().next().print();
        });


        $("input[type=checkbox][name=gridsVertical]").change(function(){
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.
            var opts = {axes: {xaxis: {tickOptions: {showGridline: this.checked}}}};
            plot1.replot(opts);
        });


        $("input[type=checkbox][name=gridsHorizontal]").change(function(){
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.
            var opts = {
                axes: {
                    yaxis: {
                        tickOptions: {showGridline: this.checked}
                    },
                    y2axis: {
                        tickOptions: {showGridline: this.checked}
                    },
                    yMidAxis: {
                        tickOptions: {showGridline: this.checked}
                    }
                }
            };
            plot1.replot(opts);
        });

        $("input[type=checkbox][name=plotBands]").change(function(){
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.
            var opts = {grid:{ rendererOptions: {plotBands: { show: this.checked}}}};
            plot1.replot(opts);
        });

        ////
        // To-Do
        //
        // initialize form elements on reload.
        // figure out what overlay line would be.
        // have to adjust ticks to do show minor.
        // make like kcp_pyramid.php
        ////
        $("input[type=checkbox][name=showMinorTicks]").change(function(){
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.
            var opts = {
                axes: {
                    yaxis: {
                        showMinorTicks: !this.checked
                    },
                    y2axis: {
                        showMinorTicks: !this.checked
                    },
                    yMidAxis: {
                        showMinorTicks: !this.checked
                    }
                }
            };
            plot1.replot(opts);
        });

        $("input[type=checkbox][name=barPadding]").change(function(){
            // this refers to the html element we are binding to.
            // $(this) is jQuery object on that element.
            if (this.checked) {
                var val = parseFloat($(this).val());
                var opts = {
                    seriesDefaults: {
                        rendererOptions: {
                            barPadding: val
                        }
                    }
                };
            }
            else {
                var opts = {
                    seriesDefaults: {
                        rendererOptions: {
                            barPadding: 0
                        }
                    }
                };
            }
            plot1.replot(opts);
        });


        $('.ui-icon-image').each(function() {
            $(this).bind('click', function(evt) {
                var chart = $(this).closest('div.quintile-outer-container').find('div.jqplot-target');
                var imgelem = chart.jqplotToImageElem();
                var div = $('div.overlay-chart-container-content');
                div.empty();
                div.append(imgelem);
                $('div.overlay-shadow').fadeIn(600);
                div.parent().fadeIn(1000);
                div = null;
            });
        });

        $('div.overlay-chart-container-header div.ui-icon-closethick').click(function(){
            var div = $('div.overlay-chart-container-content');
            div.parent().fadeOut(600);
            $('div.overlay-shadow').fadeOut(1000);
        });

        function applyColors () {
            var opts = {series:[{}, {}], grid:{rendererOptions:{plotBands:{}}}};
            opts.series[0].color = $('#colorLeft').data('colorpicker').color.toCSS();
            opts.series[1].color = $('#colorRight').data('colorpicker').color.toCSS();
            opts.grid.background = $('#colorBackground').data('colorpicker').color.toCSS();
            opts.grid.rendererOptions.plotBands.color = $('#colorPlotBands').data('colorpicker').color.toCSS();

            plot1.replot(opts);

        };

        // $('#colorLeft').val(plot1.series[0].color);

        $('#colorLeft').colorpicker({
            showOn: 'button',
            showHeader: true,
            showSwatches: true,
            buttonColorize: true,
            buttonImageOnly: true,
            parts: 'full',
            color: plot1.series[0].color,
            onClose: applyColors

        });

        $('#colorRight').colorpicker({
            showOn: 'button',
            showHeader: true,
            showSwatches: true,
            buttonColorize: true,
            buttonImageOnly: true,
            parts: 'full',
            color: plot1.series[1].color,
            onClose: applyColors

        });

        $('#colorBackground').colorpicker({
            showOn: 'button',
            showHeader: true,
            showSwatches: true,
            buttonColorize: true,
            buttonImageOnly: true,
            parts: 'full',
            color: plot1.grid.background,
            onClose: applyColors

        });

        $('#colorPlotBands').colorpicker({
            showOn: 'button',
            showHeader: true,
            showSwatches: true,
            buttonColorize: true,
            buttonImageOnly: true,
            parts: 'full',
            color: plot1.grid.plotBands.color,
            onClose: applyColors

        });

    });
	

	function LoadHTMLresultsTable(myData,sDestination){

		var i;
		var p;
		var sReturn = '';
		var sBGcol;
		var sCol;
		var iNum = 0;
		var iDen = 0;
		var sLastOU;
		
		var objNames = JSON.parse(JSON.stringify(myData.metaData.names));

		sReturn += '<table class="listTable gridTable"><thead><tr>';

		for(i = 0; i < myData.headers.length; i++) {
			sReturn += '<th>' + myData.headers[i].name + '</th>';
		}

		sReturn += '</tr></tr></thead>';
		sReturn += '<tbody>';

		for(i = 0; i < myData.rows.length; i++) {
			sReturn += '<tr>';
			for(p = 0; p < myData.headers.length; p++) {
				if (myData.headers[p].name != 'value'){
					sReturn += '<td>' + ReturnEntityLookup(objNames,myData.rows[i][p]) + '</td>';
				}
				else{
					sReturn += '<td>' + myData.rows[i][p] + '</td>';
				}
			}
			sReturn += '</tr>';
		}

		sReturn += '</tbody></table>';

		$(sDestination).html(sReturn);
	}

	function ReturnLookup(theData,dx,pe){

		var i;
		var sReturn = '';

		for(i = 0; i < theData.rows.length; i++) {
		
			if (theData.rows[i][0] == dx)
			{
				if (theData.rows[i][1] == pe)
				{
					sReturn = theData.rows[i][2];
				}
			}

		}

		return sReturn;
	}

	function ReturnEntityLookup(theData,Val){

		sReturn = theData[Val];
		return  sReturn;
	}

	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			results = regex.exec(location.search);
		return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}

    </script>



    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jquery.jqplot.min.js"></script>
    <script type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/shCore.min.js"></script>
    <script type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/shBrushJScript.min.js"></script>
    <script type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/shBrushXml.min.js"></script>


    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.categoryAxisRenderer.min.js"></script>

    <!-- load the pyramidAxis and Grid renderers in production.  pyramidRenderer will try to load via ajax if not present, but that is not optimal and depends on paths being set. -->
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.pyramidAxisRenderer.min.js"></script>
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.pyramidGridRenderer.min.js"></script> 

    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.pyramidRenderer.min.js"></script>
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.canvasTextRenderer.min.js"></script>
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/jqplot.json2.min.js"></script>
    <script class="include" type="text/javascript" src="jquery-ui/js/jquery-ui.min.js"></script>
    <script class="include" type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/kcp.print.js"></script>

    <script src="http://timesheets.hisp.org/timesheets/population/css/jquery.colorpicker.js"></script>
 
    <script type="text/javascript" src="http://timesheets.hisp.org/timesheets/population/scripts/example.min.js"></script>

	<div id='DataBlock1Content'></div>
